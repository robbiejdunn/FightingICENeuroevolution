import org.deeplearning4j.nn.conf.MultiLayerConfiguration;
import org.deeplearning4j.nn.conf.NeuralNetConfiguration;
import org.deeplearning4j.nn.conf.layers.DenseLayer;
import org.deeplearning4j.nn.conf.layers.OutputLayer;
import org.deeplearning4j.nn.multilayer.MultiLayerNetwork;
import org.nd4j.linalg.activations.Activation;
import org.nd4j.linalg.api.ndarray.INDArray;
import org.nd4j.linalg.factory.Nd4j;

import java.util.Arrays;
import java.util.Random;

/**
 * NeuralNet
 *
 * An artificial neural network using the deeplearning4j java library. Used by class Controller. Network consists of
 * 6 inputs nodes, 20 hidden layer and 7 output. Provides methods to initialise the network and feed through the
 * network with inputs of game frame data.
 *
 * Created by Robbie on 05/03/2017.
 */
public class NeuralNetwork {

    MultiLayerNetwork net;                  // Neural network: used in feed method
    double[] weights;                       // Store weights for network in readable array form

    public NeuralNetwork( ) {
        init();
    }

    private void init() {
        int numInputs = 5;      // 6 inputs from frame data
        int numHidden = 20;     // number of nodes in the hidden layer of the network
        int numOutputs = 7;     // 7 possible outputs for agent
        Random r = new Random();
        /* configuration for the neural net */
        MultiLayerConfiguration conf = new NeuralNetConfiguration.Builder()
                .iterations(100)
                .list()
                .layer(0, new DenseLayer.Builder()          // layer 0: input->hidden
                        .nIn(numInputs)
                        .nOut(numHidden)
                        .activation(Activation.TANH)
                        .build())
                .layer(1, new OutputLayer.Builder()          // layer 1: hidden->output
                        .activation(Activation.TANH)
                        .nIn(numHidden)
                        .nOut(numOutputs)
                        .build())
                .backprop(false).pretrain(false).build();

        /* initialising neural net */
        net = new MultiLayerNetwork(conf);
        net.init();

        System.out.println("Network initialised: "+numInputs+" input nodes, "+numHidden+" hidden and "
            +numOutputs+" output.");
        /* store weights in readable form for other classes */
//        weights = new double[net.params().length()];
//        for (int i=0; i < net.params().length(); i++) {
//            weights[i] = net.params().getDouble(i);
//
//        }


    }




    protected double[] feed(int myX, int myY, int enemyX, int enemyY, int energy) {
        double[] output;
        /* normalises and scales inputs accordingly */
        double myXNorm = (((double) (myX + 120) / (double) 800) * 2) - 1;           // x range -120/680
        double myYNorm = (((double) (-myY + 335) /  (double) 465) * 2) - 1;         // y range 335/-130
        double enemyXNorm = (((double) (enemyX + 120) / (double) 800) * 2) - 1;     // x as above
        double enemyYNorm = (((double) (-enemyY + 335) / (double) 465) * 2) - 1;    // y as above
        double energyNorm = (((double) energy / (double) 1000) * 2) - 1;            // energy range 0/1000
        
//        System.out.println("Network feed:\tmy x="+myXNorm+",my y="+myYNorm+",enemy x="+enemyXNorm
//            +",enemy y="+enemyYNorm+",my energy="+energyNorm);

        double[] vectorDoubles = new double[]{myXNorm, myYNorm, enemyXNorm, enemyYNorm, energyNorm};
        INDArray ia = Nd4j.create(vectorDoubles);
//        System.out.println(net.params());
        output = new double[7];
        INDArray fed = net.feedForward(ia).get(2);
        for (int i = 0; i < output.length; i++) {
            output[i] = fed.getDouble(i);
        }
        return output;
    }

    /* generate the initial sets of */
    protected void updateWeights(double[] w) {
        if (w.length != 267) {
            return;
        }
        System.out.println("Updating weights");
        weights = w;
//        System.out.println(net.params() + "\n" + net.params().length() + "\n");
        INDArray uw = Nd4j.create(w);       // updated weights for the network generated by EA
        net.setParams(uw);
//        System.out.println(net.params() + "\n" + net.params().length() + "\n");
    }

    protected double[] getWeights() {
        return weights;
    }

    public static void main(String[] args) {

        NeuralNetwork n = new NeuralNetwork();
        System.out.println("Init");
        System.out.println(n.getWeights());
        double[] t = new double[267];
        Arrays.fill(t, 0);
        n.updateWeights(t);
        System.out.println(n.getWeights().toString());
    }

}
